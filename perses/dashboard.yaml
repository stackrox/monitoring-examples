apiVersion: perses.dev/v1alpha1
kind: PersesDashboard
metadata:
  name: sample-stackrox-dashboard
  namespace: stackrox
spec:
  display:
    name: Advanced Cluster Security / Overview
  panels:
    "total_policy_violations":
      kind: "Panel"
      spec:
        display:
          name: "Total policy violations"
        plugin:
          kind: "StatChart"
          spec:
            calculation: "last"
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum(rox_central_policy_violation_namespace_severity{Cluster=~'$Cluster',Namespace=~'$Namespace'})

    "total_policies_enabled":
      kind: "Panel"
      spec:
        display:
          name: "Total policies enabled"
        plugin:
          kind: "StatChart"
          spec:
            calculation: "last"
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum(rox_central_cfg_total_policies{Enabled='true'})

    "violations_over_time_by_severity":
      kind: "Panel"
      spec:
        display:
          name: "Policy violations over time by severity"
        plugin:
          kind: "TimeSeriesChart"
          spec:
            legend:
              position: bottom
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum by (Severity)(rox_central_policy_violation_namespace_severity{Cluster=~'$Cluster',Namespace=~'$Namespace'})
                  seriesNameFormat: "{{Severity}}"

    "violations_by_severity":
      kind: "Panel"
      spec:
        display:
          name: "Policy violations by severity"
        plugin:
          kind: "BarChart"
          spec:
            calculation: "last"
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum by (Severity)(rox_central_policy_violation_namespace_severity{Cluster=~'$Cluster',Namespace=~'$Namespace'})
                  seriesNameFormat: "{{Severity}}"

    "total_vulnerabilities":
      kind: "Panel"
      spec:
        display:
          name: "Total vulnerable items"
        plugin:
          kind: "StatChart"
          spec:
            calculation: "last"
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum(rox_central_image_vuln_deployment_severity{Cluster=~'$Cluster',Namespace=~'$Namespace'})

    "total_user_fixable_vulnerabilities":
      kind: "Panel"
      spec:
        display:
          name: "Total fixable items in user workloads"
        plugin:
          kind: "StatChart"
          spec:
            calculation: "last"
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum(rox_central_image_vuln_deployment_severity{Cluster=~'$Cluster',Namespace=~'$Namespace',IsFixable="true",IsPlatformWorkload="false"})

    "vulnerabilities_by_severity":
      kind: "Panel"
      spec:
        display:
          name: "Vulnerabilities by severity"
        plugin:
          kind: "BarChart"
          spec:
            calculation: "last"
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum by (Severity)(rox_central_image_vuln_deployment_severity{Cluster=~'$Cluster',Namespace=~'$Namespace'})
                  seriesNameFormat: "{{Severity}}"

    "fixable_user_workload_vulnerabilities_over_time":
      kind: "Panel"
      spec:
        display:
          name: "Fixable user workload vulnerabilities over time"
        plugin:
          kind: "TimeSeriesChart"
          spec:
            legend:
              position: bottom
              size: small
              mode: table
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum by(Severity)(rox_central_image_vuln_deployment_severity{Cluster=~'$Cluster',Namespace=~'$Namespace',IsFixable="true",IsPlatformWorkload="false"})
                  seriesNameFormat: "{{Severity}}"

    "vulnerabilities_by_asset_over_time":
      kind: "Panel"
      spec:
        display:
          name: "Vulnerabilities by asset over time"
        plugin:
          kind: "TimeSeriesChart"
          spec:
            legend:
              mode: list
              position: bottom
              values: []
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum(rox_central_image_vuln_deployment_severity{Cluster=~'$Cluster',Namespace=~'$Namespace',IsPlatformWorkload='false'})
                  seriesNameFormat: User Image vulnerabilities
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum(rox_central_image_vuln_deployment_severity{Cluster=~'$Cluster',Namespace=~'$Namespace',IsPlatformWorkload='true'})
                  seriesNameFormat: Platform Image vulnerabilities
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum(rox_central_node_vuln_node_severity{Cluster=~'$Cluster'})
                  seriesNameFormat: Node vulnerabilities

    "cluster_health":
      kind: "Panel"
      spec:
        display:
          name: "Cluster status"
        plugin:
          kind: "Table"
          spec:
            columnSettings:
              - name: Cluster
              - name: Status
                enableSorting: true
              - name: Upgradability
                enableSorting: true
              - name: timestamp
                header: timestamp
                hide: true
              - name: value
                header: value
                hide: true
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: |
                    group by (Cluster,Status,Upgradability)
                    (rox_central_health_cluster_info{Cluster=~'$Cluster'})

    "cert_expiry":
      kind: "Panel"
      spec:
        display:
          name: "Certificate expiry per component"
        plugin:
          kind: "StatChart"
          spec:
            calculation: "last"
            format:
              decimalPlaces: 0
              unit: days
            thresholds:
              steps:
                - value: 0
                  color: red
                - value: 7
                  color: yellow
                - value: 30
                  color: green
        queries:
          - kind: "TimeSeriesQuery"
            spec:
              plugin:
                kind: "PrometheusTimeSeriesQuery"
                spec:
                  query: sum by (Component)(rox_central_cert_exp_hours / 24)
                  seriesNameFormat: "{{Component}}"

  layouts:
    - kind: Grid
      spec:
        display:
          title: Policies
          collapse:
            open: true
        items:
          - content:
              $ref: "#/spec/panels/total_policy_violations"
            "x": 0
            "y": 0
            "width": 6
            "height": 3
          - content:
              $ref: "#/spec/panels/total_policies_enabled"
            "x": 0
            "y": 3
            "width": 6
            "height": 3
          - content:
              $ref: "#/spec/panels/violations_by_severity"
            "x": 6
            "y": 0
            "width": 6
            "height": 6
          - content:
              $ref: "#/spec/panels/violations_over_time_by_severity"
            "x": 12
            "y": 0
            "width": 12
            "height": 6

    - kind: Grid
      spec:
        display:
          title: Vulnerabilities
          collapse:
            open: true
        items:
          - content:
              $ref: "#/spec/panels/total_vulnerabilities"
            "x": 0
            "y": 0
            "width": 6
            "height": 3

          - content:
              $ref: "#/spec/panels/total_user_fixable_vulnerabilities"
            "x": 0
            "y": 3
            "width": 6
            "height": 3

          - content:
              $ref: "#/spec/panels/vulnerabilities_by_severity"
            "x": 6
            "y": 0
            "width": 6
            "height": 6

          - content:
              $ref: "#/spec/panels/vulnerabilities_by_asset_over_time"
            "x": 12
            "y": 0
            "width": 12
            "height": 6

          - content:
              $ref: "#/spec/panels/fixable_user_workload_vulnerabilities_over_time"
            "x": 0
            "y": 6
            "width": 12
            "height": 12

    - kind: Grid
      spec:
        display:
          title: Cluster health
        items:
          - content:
              $ref: "#/spec/panels/cluster_health"
            "x": 0
            "y": 0
            "width": 12
            "height": 6
          - content:
              $ref: "#/spec/panels/cert_expiry"
            "x": 12
            "y": 0
            "width": 12
            "height": 6

  variables:
    - kind: ListVariable
      spec:
        name: Cluster
        allowMultiple: true
        allowAllValue: true
        plugin:
          kind: PrometheusLabelValuesVariable
          spec:
            labelName: Cluster
    - kind: ListVariable
      spec:
        name: Namespace
        allowMultiple: true
        allowAllValue: true
        plugin:
          kind: PrometheusLabelValuesVariable
          spec:
            labelName: Namespace
  duration: 30d
  refreshInterval: 1m
